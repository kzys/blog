---
title: "モックは必要悪で、しないにこしたことはない"
date: 2021-10-12T22:26:37-07:00
---
[Mockito](https://github.com/mockito/mockito) や [gomock](https://github.com/golang/mock) が使いやすいせいか、単体テストというのはモックするものである、という思い込みがあるのか、人々がモックしすぎているのを時折みかける。単体/結合テストという二分法も多分よくない。

モックは必要悪で、しないにこしたことはない。外部の API サーバーとかはガンガン叩くわけにもいかないけれど、ファイル読み書きくらいは、まあ別にディスクに書けばいいじゃない。/etc/passwd を消すようなコードだったら困るけれど、代わりに /tmp/foobar/etc/passwd を使えるように、パスのプレフィックスを指定できるようにするとか、逃げ道はいくつかあって「ファイル操作は一律モックしましょう」とか頑張りだすと辛いことになりがちだと思う。

モックの一番の問題は、本番とテストで違うコードが走ることで、これは自動テストの価値をだいぶ下げてしまう。テストが通っているのは、コードが正しいのか、コードがモックと揃っているからなのかわからなくなる。

もう一つの問題は、モックと実装が密結合してしまうことで、後々コードを変更するのが大変になる。実装が変えやすいようにテストを書くのに、実装を変えづらくなっては本末転倒だ。

[Test Double](https://martinfowler.com/bliki/TestDouble.html) の用語を使うと、ダミーオブジェクトは無害、フェイクオブジェクトが最初に面倒だけど役に立つことが多い。スタブ、スパイ、モックオブジェクトあたりは逆に簡単にはじめられるけれど最終的には後悔しがちだと思う。
