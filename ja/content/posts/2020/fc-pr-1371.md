---
title: "Firecracker パッチ日記: virtio デバイスのサイズがゼロになる"
date: 2020-09-21T08:52:24-07:00
draft: true
---
友達が仕事のことをブログに書いていたのが良かったので、自分もならって書いてみることにする。私の仕事は半分くらいがオープンソース仕事なので、実装のはなしを細かく書いてもそこまで波風はたたないだろうし、人々が歳をとるにしたがって、抽象的な「いい話」を書きがちになる流れも抗いたいので、できるだけ具体的なはなしをしたい。

私は仕事で [firecracker-containerd](https://github.com/firecracker-microvm/firecracker-containerd/) というのを作っていて、結果として時折 [Firecracker](https://firecracker-microvm.github.io/) のバグを見つけることがある。今回は去年の冬ごろに直した [PR #1317](https://github.com/firecracker-microvm/firecracker/pull/1371) のはなし。

### 何が問題だったのか

Firecracker は、ホスト OS 側のファイルを、ゲスト OS 側にファイルとして差し込むことはできない。VMM によっては [virtio-fs](https://virtio-fs.gitlab.io/
) などで実現されている機能だけど、Firecracker には無いし、[virtio-fs を追加するプルリクエスト](https://github.com/firecracker-microvm/firecracker/pull/1351) も、過去に却下されている。

代わりに、ホスト OS 側のファイルを、ゲスト OS 側にブロックデバイスとして差し込むことはできる。仮想化業界には [virtio](https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html) というこういう用途むけの OASIS で定義された仕様があって、Firecracker もそれに倣っている。

firecracker-containerd の場合は、この機能を使って、コンテナのルートファイルシステムを、起動直後の VM に差し込んでいる。

このブロックデバイスを作るときに、Firecracker では渡されたファイルに対して stat(2) を呼んで、それで得られたサイズが最終的にゲスト OS 側に渡るという実装になっていた。これは、ホスト OS 側の普通のファイルについてはうまくいくけれど、ホスト OS 側のファイルがブロックデバイスだとうまくいかない。

firecracker-containerd では、当時ループバックデバイスを作って Firecracker に渡す実装になっていたのだけど、ループバックデバイスに対して stat(2) から返ってくるサイズはゼロで、結果として、ゲスト OS から見えるブロックデバイスのサイズがゼロになってしまう、という困ったことになっていた。

### どうやって直したのか

チームの中で BLKGETSIZE64 という ioctl が使えそうという話になって、それを意気揚々とパッチにして、その関数はここにあるべきかどうかとかをプルリクエスト上で議論していたんだけど、そこで「それ lseek(2) で出来るよ」ということになり、最終的にはだいぶ小さい差分になった。

Firecracker では seccomp を使ってホスト側で使えるシステムコールを少なくするようにしているので、このためだけに許可する ioctl が増えるよりは、すでに使われている lseek(2) ですむのは都合が良い。

結果として5行の Rust の追加に対して、Python で書かれているインテグレーションテストの変更のほうがずっと長くなってしまっているのは、なかなか現代のソフトウェア開発らしさがあると思う。
